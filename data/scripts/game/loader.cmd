IF NOT DEFINED VERCODE EXIT
ECHO.[u 13%%
SET LOAD.ERR=
ECHO.[u 18%%
CALL "%PLAYERSKILLS.LOAD%"
ECHO.[u 22%%
CALL "%ITEMS.LOADER%" LIST
ECHO.[u 27%%
CALL "%ITEMS.LOADER%" LIST_EQ
ECHO.[u 34%%
CALL "%ITEMS.LOADER%" WEAPONS
ECHO.[u 38%%
CALL "%CMD.CLEARVAR%"

FOR /F "TOKENS=1DELIMS==" %%A IN ('SET LOOT.') DO (
	SET %%A=
)

:: Load the level contents
ECHO.[u 41%%
FOR /F "TOKENS=1DELIMS==" %%A IN ('SET ENEMY.TYPE.') DO SET %%A=
CALL "%LOAD.LEVEL_%%SELECTED%\setup.cmd"

SET "LOC.HP.P=[%LOC.HP%;%LOC.WP%H"

:: Count how many enemies should exist in the battle
SET EN.MAX=0
FOR /F %%I IN ('SET ENEMY.TYPE.') DO (
	SET /A EN.MAX+=1
)

ECHO.[u 46%%
SET "CNT.FADEOUT=0"
SET FADE=
SET TMP.LOC_HP_OLD=
SET ENEMY.ATK.DEALT=0
SET "PLAYER.HP.NOW=NUL"
SET "PLAYER.ATTACK.ENEMY=NONE"
SET PLAYER.ATTACK.AMOUNT=0
SET INV.SEL=0
SET "INV.SEL_NAME=ATTACK"
SET SLOTW.LINE=
SET TURNS=1
SET TURNS.T=1
SET ROUNDS=1
SET CNT=1

FOR /F "TOKENS=1DELIMS==" %%A IN ('SET ENEMY.HP.NOW.') DO (
	SET /A %%A=0
)
FOR /F "TOKENS=1DELIMS==" %%A IN ('SET FRAME.FADE.') DO (
	SET %%A=
)
FOR /F "TOKENS=1DELIMS==" %%A IN ('SET EFF.') DO (
	SET %%A=
)
FOR /F "TOKENS=1DELIMS==" %%A IN ('SET LOG.') DO (
	SET %%A=
)

ECHO.[u 50%%

SET LOOT.MAX=0
FOR /F "TOKENS=1-3DELIMS==." %%1 IN ('SET LOOT.') DO (
	IF NOT "%%2"=="MAX" IF NOT "%%3"=="ONCE" IF NOT "%%3"=="SAV" IF NOT "%%3"=="X" (
		SET /A LOOT.MAX+=1
	)
)

ECHO.[u 52%%

FOR /L %%I IN (1,1,%EN.MAX%) DO (
	CALL :CREATE-LOCATION %%I %%LOC.W%%I%% %%LOC.H%%I%%
)

SET /A "PLAYER.HP.FULL=SKILL.HP.BASE*SKILL.HP"
SET "PLAYER.ATTACK.ENEMY.R=NONE"
SET "GAME.STATUS=NUL"
SET ENEMY.ATTACK.AMOUNT=0
SET "HEAL.USES.NOW=%HEAL.USES%"
SET "BOMB.USES.NOW=%BOMB.USES%"
ECHO.[u 61%%
::HP Bar Setup
FOR /L %%I IN (1,1,%EN.MAX%) DO (
	SETLOCAL ENABLEDELAYEDEXPANSION
	FOR /F "TOKENS=1-2 DELIMS=," %%A IN ("!ENEMY.HP.AMOUNT.%%I!") DO (
		ENDLOCAL
		CALL :RAND %%I %%A %%B
	)
)
SET ENEMY.HP.FULL.T=0
FOR /F "TOKENS=4,5 DELIMS=.=" %%1 IN ('SET ENEMY.HP.NOW.') DO (
	IF %%2 GTR 0 (
		SET ENEMY.HP.FULL.%%1=%%2
		SET /A ENEMY.HP.FULL.T+=%%2
	)
)
SET PLAYER.HP.NOW=%PLAYER.HP.FULL%
SET PLAYER.HEAL.AMOUNT=0
ECHO.[u 78%%
::ENEMIES
FOR /L %%I IN (1,1,%EN.MAX%) DO (
	FOR /L %%X IN (90,-10,10) DO CALL :CREATE-HPBAR %%I %%X %%ENEMY.HP.FULL.%%I%%
	IF %%I EQU 1 ECHO.[u 80%%
	IF %%I EQU 2 ECHO.[u 82%%
)
ECHO.[u 86%%
::PLAYER
::P-90
SET /A "PLAYER.HOLO.HP.90=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.90=%PLAYER.HOLO.HP.90%*10"
SET /A "PLAYER.HOLO.HP.90=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.90%"
SET /A "PLAYER.HOLO.HP.90=%PLAYER.HOLO.HP.90%/100"
::P-80
SET /A "PLAYER.HOLO.HP.80=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.80=%PLAYER.HOLO.HP.80%*20"
SET /A "PLAYER.HOLO.HP.80=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.80%"
SET /A "PLAYER.HOLO.HP.80=%PLAYER.HOLO.HP.80%/100"
::P-70
SET /A "PLAYER.HOLO.HP.70=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.70=%PLAYER.HOLO.HP.70%*30"
SET /A "PLAYER.HOLO.HP.70=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.70%"
SET /A "PLAYER.HOLO.HP.70=%PLAYER.HOLO.HP.70%/100"
::P-60
SET /A "PLAYER.HOLO.HP.60=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.60=%PLAYER.HOLO.HP.60%*40"
SET /A "PLAYER.HOLO.HP.60=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.60%"
SET /A "PLAYER.HOLO.HP.60=%PLAYER.HOLO.HP.60%/100"
::P-50
SET /A "PLAYER.HOLO.HP.50=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.50=%PLAYER.HOLO.HP.50%*50"
SET /A "PLAYER.HOLO.HP.50=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.50%"
SET /A "PLAYER.HOLO.HP.50=%PLAYER.HOLO.HP.50%/100"
::P-40
SET /A "PLAYER.HOLO.HP.40=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.40=%PLAYER.HOLO.HP.40%*60"
SET /A "PLAYER.HOLO.HP.40=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.40%"
SET /A "PLAYER.HOLO.HP.40=%PLAYER.HOLO.HP.40%/100"
::P-30
SET /A "PLAYER.HOLO.HP.30=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.30=%PLAYER.HOLO.HP.30%*70"
SET /A "PLAYER.HOLO.HP.30=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.30%"
SET /A "PLAYER.HOLO.HP.30=%PLAYER.HOLO.HP.30%/100"
::P-20
SET /A "PLAYER.HOLO.HP.20=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.20=%PLAYER.HOLO.HP.20%*80"
SET /A "PLAYER.HOLO.HP.20=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.20%"
SET /A "PLAYER.HOLO.HP.20=%PLAYER.HOLO.HP.20%/100"
::P-10
SET /A "PLAYER.HOLO.HP.10=%PLAYER.HP.FULL%00/100"
SET /A "PLAYER.HOLO.HP.10=%PLAYER.HOLO.HP.10%*90"
SET /A "PLAYER.HOLO.HP.10=%PLAYER.HP.FULL%00-%PLAYER.HOLO.HP.10%"
SET /A "PLAYER.HOLO.HP.10=%PLAYER.HOLO.HP.10%/100"
::P-00
ECHO.[u 92%%
CALL "%SCRIPTS_GAME%\rand_enemy.cmd"
ECHO.[u 93%%
::Action Vlues
FOR /F "TOKENS=1DELIMS==" %%A IN ('SET AV.') DO (
	SET %%A=
)
SET /A AV.PLAYER=0
SET CNT=0
FOR /L %%I IN (1,1,%EN.MAX%) DO (
	SET /A CNT+=1
	CALL SET /A AV.%%CNT%%=%%CNT%%*10
)

EXIT /B 0

:CREATE-LOCATION
SET LOC.EN.%1=[%3;%2H
SET /A TMP=%2-1
SET MOV.EN.%1=[%TMP%C
SET /A TMP=%3-1
SET LOC.HP.%1=[%TMP%;%2H
EXIT /B 0

:CREATE-HPBAR
SET CNT1=%1&SET CNT2=%2&SET TMP_ENEMY.HP.FULL=%3
SET /A "ENEMY.HOLO.HP.%CNT1%.%CNT2%=%TMP_ENEMY.HP.FULL%00/100"&SET /A "ENEMY.HOLO.HP.%CNT1%.%CNT2%=ENEMY.HOLO.HP.%CNT1%.%CNT2%*(100-%CNT2%)"&SET /A "ENEMY.HOLO.HP.%CNT1%.%CNT2%=%TMP_ENEMY.HP.FULL%00-ENEMY.HOLO.HP.%CNT1%.%CNT2%"&SET /A "ENEMY.HOLO.HP.%CNT1%.%CNT2%=ENEMY.HOLO.HP.%CNT1%.%CNT2%/100"
EXIT /B 0

:RAND
SET /A "ENEMY.HP.NOW.%1=%random% %% %2 %3"
EXIT /B 0
