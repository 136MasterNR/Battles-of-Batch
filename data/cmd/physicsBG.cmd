@ECHO OFF
SET OLD_POS=3
SET PHASE=2
SET STREAK=0
:LOOP
IF NOT EXIST "..\temp\GET_POS" EXIT
SET /p GET_POS=<..\temp\GET_POS

IF %STREAK% LEQ 0 IF %GET_POS%.==%OLD_POS%. (
	CALL "../scripts/wait.exe" 10
	GOTO :LOOP
)

IF DEFINED DIRECTION IF %OLD_POS%.==%GET_POS%. IF %PHASE%==0 IF %STREAK% GEQ 2 (
	CALL "../scripts/wait.exe" 55
	IF %DIRECTION%.==1. (
		ECHO.[%GET_POS%;21H[2ABOBS
		ECHO.[%GET_POS%;21H[1A    
	)
	IF %DIRECTION%.==2. (
		ECHO.[%GET_POS%;21HBOBS
		ECHO.[%GET_POS%;21H[1A    
	)
	SET PHASE=1
	CALL "../scripts/wait.exe" 115
)
IF DEFINED DIRECTION IF %OLD_POS%.==%GET_POS%. IF %PHASE%==1 IF %STREAK% GEQ 2 (
	IF %DIRECTION%.==1. (
		ECHO.[%GET_POS%;21H[2A    
		ECHO.[%GET_POS%;21H[1ABOBS
	)
	IF %DIRECTION%.==2. (
		ECHO.[%GET_POS%;21H    
		ECHO.[%GET_POS%;21H[1ABOBS
	)
	SET STREAK=0
	SET PHASE=2
)

:: If not moved, loop
IF %GET_POS%.==%OLD_POS%. (
	IF NOT %STREAK% LEQ 0 SET /A STREAK-=1
	GOTO :LOOP
) ELSE IF NOT %STREAK% GEQ 2 SET /A STREAK+=1

IF NOT %PHASE%==0 SET PHASE=0

:: Simulate a delay
CALL "../scripts/wait.exe" 97

ECHO.[%GET_POS%;0H[1A[20CBOBS
ECHO.[%OLD_POS%;0H[1A[20C    

IF %OLD_POS%0 GEQ %GET_POS%0 SET DIRECTION=1
IF %OLD_POS%0 LEQ %GET_POS%0 SET DIRECTION=2

SET OLD_POS=%GET_POS%
GOTO :LOOP
